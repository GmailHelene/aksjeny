{% extends "base.html" %}

{% block title %}PWA Test - Aksjeradar{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">PWA Test</h1>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Enhetsinformasjon</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Browser:</dt>
                        <dd class="col-sm-8" id="browser-info">-</dd>
                        
                        <dt class="col-sm-4">Enhet:</dt>
                        <dd class="col-sm-8" id="device-info">-</dd>
                        
                        <dt class="col-sm-4">PWA Støtte:</dt>
                        <dd class="col-sm-8" id="pwa-support">-</dd>
                        
                        <dt class="col-sm-4">Service Worker:</dt>
                        <dd class="col-sm-8" id="sw-status">-</dd>
                        
                        <dt class="col-sm-4">Manifest:</dt>
                        <dd class="col-sm-8" id="manifest-status">-</dd>
                        
                        <dt class="col-sm-4">Installert:</dt>
                        <dd class="col-sm-8" id="installed-status">-</dd>
                        
                        <dt class="col-sm-4">Offline Status:</dt>
                        <dd class="col-sm-8" id="offline-status">-</dd>
                    </dl>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Test Logger</h5>
                </div>
                <div class="card-body">
                    <div id="log-messages" style="max-height: 300px; overflow-y: auto;">
                        <!-- Log messages will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

function logMessage(message, type = 'info') {
    const logDiv = document.getElementById('log-messages');
    const entry = document.createElement('div');
    entry.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} py-1 px-2 mb-1`;
    entry.innerHTML = `<small>${new Date().toLocaleTimeString()}: ${message}</small>`;
    logDiv.appendChild(entry);
    logDiv.scrollTop = logDiv.scrollHeight;
}

document.addEventListener('DOMContentLoaded', function() {
    // Check browser info
    const userAgent = navigator.userAgent;
    const browserInfo = userAgent.match(/(firefox|chrome|safari|opera|edge|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
    document.getElementById('browser-info').textContent = browserInfo[1] || 'Unknown';
    
    // Check device info
    const deviceInfo = isMobileDevice() ? 'Mobile' : 'Desktop';
    document.getElementById('device-info').textContent = deviceInfo;
    
    // Check PWA support
    const pwaSupport = ('serviceWorker' in navigator) && ('PushManager' in window);
    document.getElementById('pwa-support').innerHTML = pwaSupport 
        ? '<span class="text-success">Støttet</span>' 
        : '<span class="text-danger">Ikke støttet</span>';
    
    // Check Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistration().then(reg => {
            if (reg) {
                document.getElementById('sw-status').innerHTML = '<span class="text-success">Registrert</span>';
                logMessage('Service Worker registered', 'success');
            } else {
                document.getElementById('sw-status').innerHTML = '<span class="text-warning">Ikke registrert</span>';
                logMessage('Service Worker not registered', 'warning');
            }
        }).catch(err => {
            document.getElementById('sw-status').innerHTML = '<span class="text-danger">Feil</span>';
            logMessage('Service Worker error: ' + err.message, 'error');
        });
    } else {
        document.getElementById('sw-status').innerHTML = '<span class="text-danger">Ikke støttet</span>';
        logMessage('Service Worker not supported', 'error');
    }
    
    // Check manifest
    fetch('/static/manifest.json')
        .then(response => response.ok ? response.json() : null)
        .then(manifest => {
            const status = manifest ? 'Lastet' : 'Feil';
            const colorClass = manifest ? 'text-success' : 'text-danger';
            document.getElementById('manifest-status').innerHTML = `<span class="${colorClass}">${status}</span>`;
            logMessage(`Manifest: ${status}`, manifest ? 'success' : 'error');
        })
        .catch(() => {
            document.getElementById('manifest-status').innerHTML = '<span class="text-danger">Feil</span>';
            logMessage('Manifest load failed', 'error');
        });
    
    // Check if installed
    const isInstalled = (window.matchMedia('(display-mode: standalone)').matches) || 
                       (window.navigator.standalone === true) ||
                       (localStorage.getItem('pwa-installed') === 'true');
    const installStatus = isInstalled ? 'Ja' : 'Nei';
    const installColorClass = isInstalled ? 'text-success' : 'text-info';
    document.getElementById('installed-status').innerHTML = `<span class="${installColorClass}">${installStatus}</span>`;
    logMessage(`PWA installed: ${installStatus}`, isInstalled ? 'success' : 'info');
    
    // Check offline status
    const offlineStatus = navigator.onLine ? 'Online' : 'Offline';
    const offlineColorClass = navigator.onLine ? 'text-success' : 'text-warning';
    document.getElementById('offline-status').innerHTML = `<span class="${offlineColorClass}">${offlineStatus}</span>`;
    
    logMessage('PWA test initialization complete', 'success');
});

// Listen for online/offline events
window.addEventListener('online', () => {
    document.getElementById('offline-status').innerHTML = '<span class="text-success">Online</span>';
    logMessage('Connection restored', 'success');
});

window.addEventListener('offline', () => {
    document.getElementById('offline-status').innerHTML = '<span class="text-warning">Offline</span>';
    logMessage('Connection lost', 'warning');
});
</script>
{% endblock %}
