{% extends "base.html" %}

{% block title %}Analyse | Aksjeradar{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3">
                <i class="bi bi-graph-up-arrow"></i> Avansert Aksjeanalyse
            </h1>
            <p class="lead text-muted">
                Utforsk våre kraftige analyseverktøy for å ta informerte investeringsbeslutninger
            </p>
        </div>
    </div>

    <!-- Analysis Tools Grid -->
    <div class="row g-4">
        <!-- AI Analysis -->
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                            <i class="bi bi-robot text-primary" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-0">AI-analyse</h5>
                            <small class="text-muted">Maskinlæring</small>
                        </div>
                    </div>
                    <p class="card-text">
                        Få AI-drevne innsikter og prediksjoner basert på avanserte algoritmer og historiske data.
                    </p>
                    <a href="{{ url_for('analysis.ai') }}" class="btn btn-primary">
                        <i class="bi bi-arrow-right-circle me-1"></i> Start AI-analyse
                    </a>
                </div>
            </div>
        </div>

        <!-- Warren Buffett Analysis -->
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
                            <i class="bi bi-lightbulb text-success" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-0">Warren Buffett</h5>
                            <small class="text-muted">Verdiinvestering</small>
                        </div>
                    </div>
                    <p class="card-text">
                        Analyser aksjer med Warren Buffetts investeringsprinsipper og finn undervurderte selskaper.
                    </p>
                    <a href="{{ url_for('analysis.warren_buffett') }}" class="btn btn-success">
                        <i class="bi bi-arrow-right-circle me-1"></i> Buffett-analyse
                    </a>
                </div>
            </div>
        </div>

        <!-- Benjamin Graham Analysis -->
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3">
                            <i class="bi bi-book text-info" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-0">Benjamin Graham</h5>
                            <small class="text-muted">Fundamental analyse</small>
                        </div>
                    </div>
                    <p class="card-text">
                        Bruk Benjamin Grahams tidløse prinsipper for å identifisere solide investeringsmuligheter.
                    </p>
                    <a href="{{ url_for('analysis.benjamin_graham') }}" class="btn btn-info">
                        <i class="bi bi-arrow-right-circle me-1"></i> Graham-analyse
                    </a>
                </div>
            </div>
        </div>

        <!-- Short Analysis -->
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-danger bg-opacity-10 p-3 me-3">
                            <i class="bi bi-arrow-down-circle text-danger" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-0">Short Analyse</h5>
                            <small class="text-muted">Risikovurdering</small>
                        </div>
                    </div>
                    <p class="card-text">
                        Identifiser potensielle svakheter og risikoer i selskaper før du investerer.
                    </p>
                    <a href="{{ url_for('analysis.short_analysis') }}" class="btn btn-danger">
                        <i class="bi bi-arrow-right-circle me-1"></i> Short-analyse
                    </a>
                </div>
            </div>
        </div>

        <!-- Technical Analysis -->
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-warning bg-opacity-10 p-3 me-3">
                            <i class="bi bi-graph-up text-warning" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-0">Teknisk Analyse</h5>
                            <small class="text-muted">Trender & mønstre</small>
                        </div>
                    </div>
                    <p class="card-text">
                        Analyser prisbevegelser, volum og tekniske indikatorer for timing av handler.
                    </p>
                    <a href="{{ url_for('analysis.technical') }}" class="btn btn-warning">
                        <i class="bi bi-arrow-right-circle me-1"></i> Teknisk analyse
                    </a>
                </div>
            </div>
        </div>

        <!-- Market Overview -->
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-secondary bg-opacity-10 p-3 me-3">
                            <i class="bi bi-globe text-secondary" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-0">Markedsoversikt</h5>
                            <small class="text-muted">Global innsikt</small>
                        </div>
                    </div>
                    <p class="card-text">
                        Få oversikt over globale markeder, sektorer og makroøkonomiske trender.
                    </p>
                    <a href="{{ url_for('analysis.market_overview') }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-right-circle me-1"></i> Se markedsoversikt
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Features Section -->
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="mb-4">Hvorfor bruke våre analyseverktøy?</h3>
        </div>
        <div class="col-md-4">
            <div class="d-flex mb-3">
                <i class="bi bi-check-circle-fill text-success me-3" style="font-size: 1.5rem;"></i>
                <div>
                    <h5>Datadrevet innsikt</h5>
                    <p class="text-muted">Basert på sanntidsdata og historiske trender fra pålitelige kilder.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="d-flex mb-3">
                <i class="bi bi-shield-fill-check text-primary me-3" style="font-size: 1.5rem;"></i>
                <div>
                    <h5>Beprøvde metoder</h5>
                    <p class="text-muted">Bruk anerkjente investeringsstrategier fra legendariske investorer.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="d-flex mb-3">
                <i class="bi bi-lightning-charge-fill text-warning me-3" style="font-size: 1.5rem;"></i>
                <div>
                    <h5>Rask analyse</h5>
                    <p class="text-muted">Få omfattende analyser på sekunder, spar tid og ta bedre beslutninger.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Tips -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="alert alert-info">
                <h5 class="alert-heading">
                    <i class="bi bi-lightbulb me-2"></i>Tips for best resultat
                </h5>
                <ul class="mb-0">
                    <li>Kombiner flere analysemetoder for en helhetlig vurdering</li>
                    <li>Sammenlign resultater over tid for å se trender</li>
                    <li>Bruk teknisk analyse for timing og fundamental analyse for verdi</li>
                    <li>Husk at ingen analyse garanterer fremtidig avkastning</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom styles for analysis overview page */
.card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
}

.btn {
    transition: all 0.2s ease-in-out;
}

.btn:hover {
    transform: scale(1.05);
}

.rounded-circle {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
{% endblock %}
            if (data.success) {
                const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
                notificationItem.classList.remove('border-primary');
                const markReadBtn = notificationItem.querySelector('.mark-read-btn');
                if (markReadBtn) {
                    markReadBtn.remove();
                }
                showToast('Varsel markert som lest', 'success');
            } else {
                showToast(data.error || 'Kunne ikke markere som lest', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('En feil oppstod', 'error');
        });
    }

    function markAllAsRead() {
        fetch('/notifications/api/mark-all-read', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                showToast(data.error || 'Kunne ikke markere alle som lest', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('En feil oppstod', 'error');
        });
    }

    function deleteNotification(notificationId) {
        if (!confirm('Er du sikker på at du vil slette dette varselet?')) {
            return;
        }

        fetch(`/notifications/api/delete/${notificationId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
                notificationItem.remove();
                showToast('Varsel slettet', 'success');
            } else {
                showToast(data.error || 'Kunne ikke slette varsel', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('En feil oppstod', 'error');
        });
    }

    function showToast(message, type) {
        const toast = document.getElementById('feedbackToast');
        const toastBody = toast.querySelector('.toast-body');
        toastBody.textContent = message;
        
        // Update toast styling based on type
        toast.className = `toast ${type === 'success' ? 'bg-success text-white' : 'bg-danger text-white'}`;
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }

    function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }
});
</script>
{% endblock %}
    } catch (error) {
        console.error('Error updating unread count:', error);
    }
}

function updateCounts(unreadCount, totalCount) {
    document.getElementById('unread-count').textContent = unreadCount;
    document.getElementById('total-count').textContent = totalCount;
}

async function sendTestNotification() {
    try {
        const response = await fetch('/api/notifications/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                title: 'Test Notification',
                message: 'Dette er en testnotifikasjon fra Aksjeradar. Hvis du ser denne, fungerer varselsystemet!'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess('Testnotifikasjon sendt!');
            setTimeout(() => {
                loadNotifications(currentFilter);
                updateUnreadCount();
            }, 1000);
        } else {
            showError('Feil ved sending av testnotifikasjon: ' + data.error);
        }
    } catch (error) {
        showError('Nettverksfeil ved sending av testnotifikasjon');
        console.error('Error sending test notification:', error);
    }
}

async function enablePushNotifications() {
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        showError('Push-notifikasjoner støttes ikke i denne nettleseren');
        return;
    }
    
    try {
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            showError('Push-notifikasjoner avvist. Aktiver i nettleserinnstillingene.');
            return;
        }
        
        // Register service worker and get push subscription
        const registration = await navigator.serviceWorker.register('/static/service-worker.js');
        const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: 'YOUR_VAPID_PUBLIC_KEY' // Replace with actual VAPID key
        });
        
        // Save subscription to server
        const response = await fetch('/api/notifications/push_subscription', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(subscription)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess('Push-notifikasjoner aktivert!');
        } else {
            showError('Feil ved aktivering av push-notifikasjoner: ' + data.error);
        }
    } catch (error) {
        showError('Feil ved aktivering av push-notifikasjoner');
        console.error('Error enabling push notifications:', error);
    }
}

function showSuccess(message) {
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function showError(message) {
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-danger border-0 position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}
</script>
