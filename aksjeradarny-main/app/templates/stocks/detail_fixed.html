{% extends 'base.html' %}

{% block title %}{{ ticker }} - Aksjedetaljer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Hjem</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('stocks.index') }}">Aksjer</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ ticker }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h2 class="mb-0">
                          {% if stock_info and stock_info.longName %}
                            {{ stock_info.longName }}
                          {% elif stock_info and stock_info.shortName %}
                            {{ stock_info.shortName }}
                          {% elif ticker %}
                            {% if ticker == 'EQNR.OL' %}Equinor ASA
                            {% elif ticker == 'DNB.OL' %}DNB Bank ASA
                            {% elif ticker == 'TEL.OL' %}Telenor ASA
                            {% elif ticker == 'YAR.OL' %}Yara International ASA
                            {% elif ticker == 'NHY.OL' %}Norsk Hydro ASA
                            {% elif ticker == 'MOWI.OL' %}Mowi ASA
                            {% elif ticker == 'ORK.OL' %}Orkla ASA
                            {% elif ticker == 'SALM.OL' %}SalMar ASA
                            {% elif ticker == 'AAPL' %}Apple Inc.
                            {% elif ticker == 'MSFT' %}Microsoft Corporation
                            {% elif ticker == 'AMZN' %}Amazon.com Inc.
                            {% elif ticker == 'GOOGL' %}Alphabet Inc.
                            {% elif ticker == 'META' %}Meta Platforms Inc.
                            {% elif ticker == 'TSLA' %}Tesla Inc.
                            {% elif ticker == 'NVDA' %}NVIDIA Corporation
                            {% elif ticker == 'BTC-USD' %}Bitcoin
                            {% elif ticker == 'ETH-USD' %}Ethereum
                            {% else %}{{ ticker }}
                            {% endif %}
                          {% else %}
                            Ukjent selskap
                          {% endif %}
                        </h2>
                        <p class="text-muted">{{ ticker }}</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="mb-2">
                            {% if current_user.is_authenticated %}
                            <button id="add-to-watchlist" class="btn btn-success me-2" data-ticker="{{ ticker }}">
                                <i class="bi bi-star"></i> Legg til i favoritter
                            </button>
                            <button id="add-to-portfolio" class="btn btn-primary" data-ticker="{{ ticker }}">
                                <i class="bi bi-briefcase"></i> Legg til i portefølje
                            </button>
                            {% else %}
                            <a href="{{ url_for('main.login') }}" class="btn btn-outline-success me-2">
                                <i class="bi bi-star"></i> Logg inn for favoritter
                            </a>
                            <a href="{{ url_for('main.login') }}" class="btn btn-outline-primary">
                                <i class="bi bi-briefcase"></i> Logg inn for portefølje
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Price Information -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <h5>Siste pris</h5>
                                        <h3 class="text-primary">
                                            {% if stock_data and stock_data.last_price %}
                                                {{ "%.2f"|format(stock_data.last_price) }} {{ stock_data.currency or 'NOK' }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </h3>
                                    </div>
                                    <div class="col-md-3">
                                        <h5>Endring</h5>
                                        <h4 class="{% if stock_data and stock_data.change_percent and stock_data.change_percent > 0 %}text-success{% elif stock_data and stock_data.change_percent and stock_data.change_percent < 0 %}text-danger{% else %}text-muted{% endif %}">
                                            {% if stock_data and stock_data.change_percent %}
                                                {{ "%.2f"|format(stock_data.change_percent) }}%
                                            {% else %}
                                                0.00%
                                            {% endif %}
                                        </h4>
                                    </div>
                                    <div class="col-md-3">
                                        <h5>Volum</h5>
                                        <p>
                                            {% if stock_data and stock_data.volume %}
                                                {{ "{:,}".format(stock_data.volume) }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-md-3">
                                        <h5>Markedsverdi</h5>
                                        <p>
                                            {% if stock_data and stock_data.market_cap %}
                                                {{ stock_data.market_cap }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Stock Information -->
                {% if stock_info %}
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Selskapsdetaljer</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% if stock_info.get('sector') %}
                                    <div class="col-md-4 mb-3">
                                        <strong>Sektor:</strong><br>
                                        {{ stock_info.sector }}
                                    </div>
                                    {% endif %}
                                    {% if stock_info.get('industry') %}
                                    <div class="col-md-4 mb-3">
                                        <strong>Bransje:</strong><br>
                                        {{ stock_info.industry }}
                                    </div>
                                    {% endif %}
                                    {% if stock_info.get('country') %}
                                    <div class="col-md-4 mb-3">
                                        <strong>Land:</strong><br>
                                        {{ stock_info.country }}
                                    </div>
                                    {% endif %}
                                    {% if stock_info.get('website') %}
                                    <div class="col-md-4 mb-3">
                                        <strong>Nettside:</strong><br>
                                        <a href="{{ stock_info.website }}" target="_blank" class="text-primary">{{ stock_info.website }}</a>
                                    </div>
                                    {% endif %}
                                    {% if stock_info.get('fullTimeEmployees') %}
                                    <div class="col-md-4 mb-3">
                                        <strong>Ansatte:</strong><br>
                                        {{ "{:,}".format(stock_info.fullTimeEmployees) }}
                                    </div>
                                    {% endif %}
                                    {% if stock_info.get('dividendYield') %}
                                    <div class="col-md-4 mb-3">
                                        <strong>Utbytteavkastning:</strong><br>
                                        {{ "%.2f"|format(stock_info.dividendYield * 100) }}%
                                    </div>
                                    {% endif %}
                                </div>
                                {% if stock_info.get('longBusinessSummary') %}
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <strong>Beskrivelse:</strong><br>
                                        <p class="mt-2">{{ stock_info.longBusinessSummary }}</p>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Chart -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Pris historikk</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="stockChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- News Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Seneste nyheter</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% if stock_info and stock_info.get('news') and stock_info.get('news')|length > 0 %}
                        {% for news_item in stock_info.get('news', [])[:5] %}
                            <a href="{{ news_item.get('link', '#') }}" class="list-group-item list-group-item-action" target="_blank">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ news_item.get('title', 'Ingen tittel') }}</h6>
                                    <small>{{ news_item.get('providerPublishTime', '')|safe }}</small>
                                </div>
                                <p class="mb-1">{{ news_item.get('publisher', news_item.get('source', 'Finansnyheter')) }}</p>
                            </a>
                        {% endfor %}
                    {% else %}
                        <div class="list-group-item">Ingen nylige nyheter tilgjengelig.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Related Stocks Section -->
        <div class="card">
            <div class="card-header">
                <h5>Relaterte aksjer</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% if stock_info and stock_info.get('recommendedSymbols') and stock_info.get('recommendedSymbols')|length > 0 %}
                        {% for symbol in stock_info.get('recommendedSymbols', [])[:5] %}
                            <a href="{{ url_for('stocks.details', ticker=symbol) }}" class="list-group-item list-group-item-action">
                                {{ symbol }}
                            </a>
                        {% endfor %}
                    {% elif related_stocks %}
                        {% for stock in related_stocks[:5] %}
                            <a href="{{ url_for('stocks.details', ticker=stock.ticker) }}" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ stock.ticker }}</h6>
                                    <small class="{% if stock.change_percent and stock.change_percent > 0 %}text-success{% elif stock.change_percent and stock.change_percent < 0 %}text-danger{% else %}text-muted{% endif %}">
                                        {% if stock.change_percent %}{{ "%.2f"|format(stock.change_percent) }}%{% endif %}
                                    </small>
                                </div>
                                {% if stock.last_price %}
                                <p class="mb-1">{{ "%.2f"|format(stock.last_price) }} {{ stock.currency or 'NOK' }}</p>
                                {% endif %}
                            </a>
                        {% endfor %}
                    {% else %}
                        <div class="list-group-item">Ingen relaterte aksjer tilgjengelig.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="stock-data">
    {{ stock_data|tojson if stock_data else '{}' }}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Chart functionality
        const chartElem = document.getElementById('stockChart');
        const stockDataElem = document.getElementById('stock-data');
        let stockData = {};
        
        if (stockDataElem && stockDataElem.textContent.trim()) {
            try {
                stockData = JSON.parse(stockDataElem.textContent);
            } catch (e) {
                console.log('Could not parse stock data:', e);
                stockData = {};
            }
        }

        // Initialize chart if data is available
        if (chartElem && stockData.historical_data) {
            // Add chart initialization logic here
            console.log('Chart data available:', stockData.historical_data.length, 'points');
        }

        // Add to watchlist button
        const watchBtn = document.getElementById('add-to-watchlist');
        if (watchBtn) {
            watchBtn.addEventListener('click', async function() {
                const ticker = this.getAttribute('data-ticker');
                try {
                    const response = await fetch('/api/watchlist/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                        },
                        body: JSON.stringify({ ticker: ticker })
                    });
                    
                    if (response.headers.get('content-type')?.includes('application/json')) {
                        const data = await response.json();
                        if (response.ok) {
                            alert('Aksjen er lagt til i favoritter!');
                            this.disabled = true;
                            this.innerHTML = '<i class="bi bi-star-fill"></i> Lagt til i favoritter';
                        } else {
                            alert(data.error || 'Kunne ikke legge til i favoritter.');
                        }
                    } else {
                        alert('Du må logge inn for å legge til favoritter.');
                        window.location.href = '/login';
                    }
                } catch (error) {
                    console.error('Error adding to watchlist:', error);
                    alert('En feil oppstod: ' + error.message);
                }
            });
        }

        // Add to portfolio button
        const portfolioBtn = document.getElementById('add-to-portfolio');
        if (portfolioBtn) {
            portfolioBtn.addEventListener('click', async function() {
                const ticker = this.getAttribute('data-ticker');
                const shares = prompt('Hvor mange aksjer vil du legge til?', '1');
                
                if (shares === null || isNaN(shares) || shares <= 0) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/portfolio/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                        },
                        body: JSON.stringify({ 
                            ticker: ticker,
                            shares: parseInt(shares)
                        })
                    });
                    
                    if (response.headers.get('content-type')?.includes('application/json')) {
                        const data = await response.json();
                        if (response.ok) {
                            alert(`${shares} aksjer av ${ticker} er lagt til i porteføljen!`);
                            this.innerHTML = '<i class="bi bi-briefcase-fill"></i> Lagt til i portefølje';
                        } else {
                            alert(data.error || 'Kunne ikke legge til i porteføljen.');
                        }
                    } else {
                        alert('Du må logge inn for å legge til i portefølje.');
                        window.location.href = '/login';
                    }
                } catch (error) {
                    console.error('Error adding to portfolio:', error);
                    alert('En feil oppstod: ' + error.message);
                }
            });
        }
    });
</script>
{% endblock %}